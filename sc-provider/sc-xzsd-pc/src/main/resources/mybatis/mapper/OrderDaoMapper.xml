<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xzsd.pc.order.dao.OrderDao">
    <!--查件-->
    <select id="listOrders" parameterType="com.xzsd.pc.order.entity.OrderInfo" resultType="com.xzsd.pc.order.entity.OrderInfo">
        select
            a.order_id orderId,
            b.line_name lineName,
            c.site_name originSiteName,
            d.site_name destinationSiteName,
            a.receiver_name receiverName,
            a.receiver_phone receiverPhone,
            weight,
            postage,
            order_state orderState,
            bag_id bagId,
            e.account,
            e.phone,
            a.gmt_create gmtCreate
        from
            t_sys_order a,t_sys_line b,t_sys_site c,t_sys_site d,t_sys_user e
        where
            a.is_deleted = 0
            and a.line_id = b.line_id
            and a.origin_site_id = c.site_id
            and a.destination_site_id = d.site_id
            and a.user_id = e.user_id
        <if test="role == 4">
            and a.user_id = #{userId}
        </if>
        <if test="orderId != null and orderId !=''">
            and order_id = #{orderId}
        </if>
        <if test="account != null and account !=''">
            and e.account like concat('%',#{account},'%')
        </if>
        <if test="phone != null and phone !=''">
            and e.phone like concat('%',#{phone},'%')
        </if>
        <if test="orderState != null and orderState !=''">
            and order_state = #{orderState}
        </if>
        <if test="payTimeStart != null and payTimeEnd != null">
            and a.gmt_create
            between #{payTimeStart} and #{payTimeEnd}
        </if>
        order by a.gmt_create desc
    </select>
    <!--查询站点编号列表-->
    <select id="queryNextSiteById" parameterType="java.lang.String" resultType="com.xzsd.pc.site.entity.SiteInfo">
        select
            dictionary_id dictionaryId,
            v
        from
            t_sys_dictionary
        where
            is_deleted = 0
            and last_classify_id = #{lastClassifyId}
    </select>
    <!--在线下单-->
    <insert id="addOrder" parameterType="com.xzsd.pc.order.entity.OrderInfo">
        insert into t_sys_order
            (
                order_id,
                line_id,
                origin_site_id,
                destination_site_id,
                receiver_name,
                receiver_phone,
                weight,
                postage,
                order_state,
                user_id,
                is_deleted,
                create_by,
                gmt_create,
                last_modified_by,
                gmt_modified,
                version
            )
        values
            (
                #{orderId},
                #{lineId},
                #{originSiteId},
                #{destinationSiteId},
                #{receiverName},
                #{receiverPhone},
                #{weight},
                #{postage},
                0,
                #{userId},
                0,
                #{createBy},
                now(),
                #{lastModifiedBy},
                now(),
                0
            )
    </insert>
    <!--订单详情-->
    <select id="findOrderById" parameterType="java.lang.String" resultType="com.xzsd.pc.record.entity.RecordInfo">
        select
            order_id orderId,
            site_id siteId,
            order_state orderState,
            gmt_create
        from
            t_sys_record
        where
            is_deleted = 0
            and order_id = #{orderId}
        order by gmt_create desc
    </select>
    <!--订单状态修改-->
    <update id="updateOrderState" parameterType="com.xzsd.pc.order.entity.OrderInfo">
        update
            t_sys_order
        set
            order_state = #{orderState},
            gmt_modified = now(),
            last_modified_by = #{updateUserId},
            version = version + 1
        where
            order_id in
        <foreach item="item" index="index" collection="listUpdateOrderId" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>
    <!--查询订单总数-->
    <select id="queryOrderSum" resultType="java.lang.String">
        select
            count(*)
        from
            t_sys_order
        where
            is_deleted = 0
    </select>
</mapper>